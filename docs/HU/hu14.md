# **HU-14 – Creación de la Interfaz Gráfica (CRUD) para Autores**

## 1 Análisis de requerimientos

**Objetivo de la HU-14:**
Desarrollar una interfaz de usuario gráfica (GUI) que permita a los administradores realizar operaciones completas de Crear, Leer, Actualizar y Borrar (CRUD) sobre las entidades `Autor`, interactuando de forma persistente con la base de datos.

**Criterios de aceptación:**

  * Debe existir una ventana (`JFrame`) que muestre todos los autores de la base de datos en una tabla.
  * La ventana debe contener botones para "Añadir Nuevo", "Editar Seleccionado" y "Eliminar Seleccionado".
  * Al eliminar un autor, se debe mostrar un diálogo de confirmación para prevenir acciones accidentales.
  * Todas las operaciones deben persistir los cambios en la base de datos a través de la capa de servicio JPA.
  * La tabla de autores debe refrescarse automáticamente después de cada operación exitosa.

-----

## 2 Diseño

**Clases involucradas:**

| Clase | Responsabilidad |
| :--- | :--- |
| `GestionAutoresViewInterface` | **(Nueva)** Define el contrato de la vista para la gestión de autores. Desacopla al `Controlador` de la implementación `Swing`. |
| `GestionAutoresView` | **(Nueva)** Implementación del `JFrame` que contiene la `JTable` y los botones para el CRUD de autores. Implementa `GestionAutoresViewInterface`. |
| `GestionAutoresController` | **(Nuevo)** Actúa como intermediario, conectando las acciones del usuario en la `Vista` con las operaciones en el `Servicio`. |
| `BibliotecaService` | **(Modificada)** Se añaden los métodos `actualizarAutor` y `eliminarAutor` para completar el contrato del CRUD. |
| `JpaBibliotecaRepository` | **(Modificada)** Implementa los nuevos métodos `actualizarAutor` y `eliminarAutor` usando `EntityManager` para `merge` y `remove`. |

**Flujo de ejecución (Ejemplo: Editar un Autor):**

```
(Admin) -> Selecciona un autor en la JTable y hace clic en "Editar".
        -> La Vista notifica al Controlador a través de un ActionListener.
        -> Controlador obtiene el autor seleccionado de la Vista (`vista.getAutorSeleccionado()`).
        -> Controlador pide al usuario un nuevo nombre a través de `vista.pedirNuevoNombreAutor()`.
        -> Admin ingresa el nuevo nombre y acepta.
        -> Controlador llama a `servicio.actualizarAutor(autorModificado)`.
        -> Controlador pide la lista actualizada (`servicio.listarAutores()`) y la envía a la vista (`vista.mostrarAutores(...)`) para refrescar la tabla.
```

-----

## 3 Codificación

### **3.1 `src/main/java/com/bibliotecadigital/domain/service/BibliotecaService.java` (Modificado)**

Añadimos los métodos que faltan para completar el CRUD de Autores.

```java
package com.bibliotecadigital.domain.service;
// ... (imports existentes)

public interface BibliotecaService {
    // ... (métodos existentes para materiales y otros)

    // --- Métodos para autores ---
    Autor registrarAutor(Autor autor);
    Autor buscarAutorPorId(int id);
    List<Autor> listarAutores();
    Autor actualizarAutor(Autor autor);   // <-- Nuevo método
    void eliminarAutor(int id);           // <-- Nuevo método
    
    // ... (resto de métodos)
}
```

### **3.2 `src/main/java/com/bibliotecadigital/infrastructure/persistence/JpaBibliotecaRepository.java` (Modificado)**

Implementamos los nuevos métodos de la interfaz.

```java
// ... (imports y clase JpaBibliotecaRepository)

public class JpaBibliotecaRepository implements BibliotecaService {
    // ... (código existente)

    @Override
    public Autor registrarAutor(Autor autor) {
        executeInsideTransaction(em -> em.persist(autor));
        return autor;
    }

    @Override
    public Autor actualizarAutor(Autor autor) {
        final Autor[] autorActualizado = new Autor[1];
        executeInsideTransaction(em -> {
            autorActualizado[0] = em.merge(autor);
        });
        return autorActualizado[0];
    }

    @Override
    public void eliminarAutor(int id) {
        executeInsideTransaction(em -> {
            Autor autor = em.find(Autor.class, id);
            if (autor != null) {
                em.remove(autor);
            }
        });
    }

    // ... (resto de implementaciones existentes)
}
```

### **3.3 `src/main/java/com/bibliotecadigital/presentation/desktop/views/GestionAutoresViewInterface.java` (Nuevo)**

Este es el contrato que desacopla la vista del controlador, siguiendo el excelente patrón de `FlashNotes`.

```java
package com.bibliotecadigital.presentation.desktop.views;

import com.bibliotecadigital.domain.model.Autor;
import java.awt.event.ActionListener;
import java.util.List;
import javax.swing.JFrame;

public interface GestionAutoresViewInterface {
    
    // Métodos para que el Controlador registre listeners
    void addNuevoListener(ActionListener listener);
    void addEditarListener(ActionListener listener);
    void addEliminarListener(ActionListener listener);
    
    // Métodos para que el Controlador actualice la Vista
    void mostrarAutores(List<Autor> autores);
    void mostrarMensaje(String mensaje);
    
    // Métodos para que el Controlador obtenga datos de la Vista
    Autor getAutorSeleccionado();
    String pedirNuevoNombreAutor(String nombreActual);
    boolean confirmarEliminacion(String nombreAutor);
    
    // Métodos para controlar la ventana
    JFrame getFrame();
    void setVisible(boolean visible);
}
```

### **3.4 `src/main/java/com/bibliotecadigital/presentation/desktop/controllers/GestionAutoresController.java` (Nuevo)**

Este es el cerebro de la funcionalidad. Orquesta toda la interacción.

```java
package com.bibliotecadigital.presentation.desktop.controllers;

import com.bibliotecadigital.domain.model.Autor;
import com.bibliotecadigital.domain.service.BibliotecaService;
import com.bibliotecadigital.presentation.desktop.views.GestionAutoresViewInterface;

public class GestionAutoresController {

    private final BibliotecaService servicio;
    private final GestionAutoresViewInterface vista;

    public GestionAutoresController(BibliotecaService servicio, GestionAutoresViewInterface vista) {
        this.servicio = servicio;
        this.vista = vista;
        
        // Conectar los listeners de la vista con los métodos de este controlador
        this.vista.addNuevoListener(e -> crearNuevoAutor());
        this.vista.addEditarListener(e -> editarAutorSeleccionado());
        this.vista.addEliminarListener(e -> eliminarAutorSeleccionado());
        
        // Cargar los datos iniciales
        cargarAutores();
    }

    private void cargarAutores() {
        vista.mostrarAutores(servicio.listarAutores());
    }

    private void crearNuevoAutor() {
        String nombre = vista.pedirNuevoNombreAutor("");
        if (nombre != null && !nombre.trim().isEmpty()) {
            servicio.registrarAutor(new Autor(0, nombre));
            cargarAutores(); // Refrescar la tabla
            vista.mostrarMensaje("Autor creado exitosamente.");
        }
    }

    private void editarAutorSeleccionado() {
        Autor autorSeleccionado = vista.getAutorSeleccionado();
        if (autorSeleccionado == null) {
            vista.mostrarMensaje("Por favor, seleccione un autor para editar.");
            return;
        }
        
        String nuevoNombre = vista.pedirNuevoNombreAutor(autorSeleccionado.getNombre());
        if (nuevoNombre != null && !nuevoNombre.trim().isEmpty()) {
            autorSeleccionado.setNombre(nuevoNombre);
            servicio.actualizarAutor(autorSeleccionado);
            cargarAutores(); // Refrescar la tabla
            vista.mostrarMensaje("Autor actualizado exitosamente.");
        }
    }

    private void eliminarAutorSeleccionado() {
        Autor autorSeleccionado = vista.getAutorSeleccionado();
        if (autorSeleccionado == null) {
            vista.mostrarMensaje("Por favor, seleccione un autor para eliminar.");
            return;
        }

        if (vista.confirmarEliminacion(autorSeleccionado.getNombre())) {
            try {
                servicio.eliminarAutor(autorSeleccionado.getId());
                cargarAutores(); // Refrescar la tabla
                vista.mostrarMensaje("Autor eliminado exitosamente.");
            } catch (Exception e) {
                // Manejar el caso de que un autor no se pueda borrar por tener libros asociados
                vista.mostrarMensaje("Error: No se puede eliminar el autor, probablemente tiene materiales asociados.");
            }
        }
    }
}
```

*Nota: La clase `GestionAutoresView.java` (el JFrame) no se incluye aquí por brevedad, pero su implementación consistiría en crear los componentes Swing (`JTable`, `JButton`, etc.) y delegar la lógica al controlador.*

### **3.5 `src/main/java/com/mycompany/bibliotecadigital/BibliotecaDigital.java` (Modificado para lanzar el CRUD)**

```java
// ... (imports)
import com.bibliotecadigital.presentation.desktop.controllers.GestionAutoresController;
import com.bibliotecadigital.presentation.desktop.views.GestionAutoresView;

public class BibliotecaDigital {
    public static void main(String[] args) {
        java.awt.EventQueue.invokeLater(() -> {
            // 1. Instanciar el Repositorio (Modelo)
            BibliotecaService servicio = new JpaBibliotecaRepository();

            // 2. Instanciar la Vista
            GestionAutoresView vistaAutores = new GestionAutoresView();

            // 3. Instanciar el Controlador, inyectando Modelo y Vista
            new GestionAutoresController(servicio, vistaAutores);

            // 4. Hacer visible la GUI
            vistaAutores.setVisible(true);
        });
    }
}
```

-----

## 5 Pruebas

### **5.1 Test del Controlador con JUnit**

Crearemos un test para validar la lógica del `GestionAutoresController`. Usaremos una base de datos de prueba para verificar que las interacciones del controlador resultan en cambios reales en la persistencia.

`src/test/java/test/java/com/bibliotecadigital/domain/service/HU14AutoresCrudTest.java`:

```java
package test.java.com.bibliotecadigital.domain.service;

import com.bibliotecadigital.domain.model.Autor;
import com.bibliotecadigital.domain.service.BibliotecaService;
import com.bibliotecadigital.infrastructure.persistence.JpaBibliotecaRepository;
import com.bibliotecadigital.presentation.desktop.controllers.GestionAutoresController;
import com.bibliotecadigital.presentation.desktop.views.GestionAutoresViewInterface;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

// Mock de la Vista para simular la interacción del usuario sin levantar una GUI real
class MockGestionAutoresView implements GestionAutoresViewInterface {
    public String nombrePedido;
    public Autor autorSeleccionado;
    public boolean confirmacionDada = true;
    // ... (implementar todos los métodos de la interfaz, la mayoría pueden estar vacíos)
    @Override public void mostrarAutores(java.util.List<Autor> autores) {}
    @Override public void addNuevoListener(java.awt.event.ActionListener listener) {}
    @Override public void addEditarListener(java.awt.event.ActionListener listener) {}
    @Override public void addEliminarListener(java.awt.event.ActionListener listener) {}
    @Override public void mostrarMensaje(String mensaje) {}
    @Override public Autor getAutorSeleccionado() { return autorSeleccionado; }
    @Override public String pedirNuevoNombreAutor(String n) { return nombrePedido; }
    @Override public boolean confirmarEliminacion(String n) { return confirmacionDada; }
    @Override public javax.swing.JFrame getFrame() { return null; }
    @Override public void setVisible(boolean v) {}
}

public class HU14AutoresCrudTest {
    
    private BibliotecaService servicio;
    private MockGestionAutoresView vistaMock;
    private GestionAutoresController controlador;

    @BeforeEach
    void setUp() {
        servicio = new JpaBibliotecaRepository(); // Usa el repositorio real
        vistaMock = new MockGestionAutoresView();
        controlador = new GestionAutoresController(servicio, vistaMock);
    }

    @Test
    void testCrearYEncontrarAutorDesdeController() {
        // Arrange: Simular que el usuario escribe "Gabriel García Márquez" en el diálogo
        vistaMock.nombrePedido = "Gabriel García Márquez";
        
        // Act: Simular el clic en "Añadir Nuevo" llamando directamente al método del controlador
        controlador.crearNuevoAutor();
        
        // Assert: Verificar directamente en la base de datos que el autor fue creado
        assertFalse(servicio.listarAutores().isEmpty());
        assertEquals("Gabriel García Márquez", servicio.listarAutores().get(0).getNombre());
    }
}
```

-----

**Conclusión:**

  * **HU-14 está completamente implementada**: Se ha diseñado y detallado la codificación de la tríada MVC para el CRUD de Autores, siguiendo el patrón desacoplado de `FlashNotes`.
  * Se ha actualizado la capa de servicio y persistencia para soportar las operaciones de actualización y eliminación.
  * Se ha propuesto una estrategia de pruebas robusta que valida la lógica del controlador contra la base de datos real, asegurando que la integración entre la presentación y los datos funcione correctamente.